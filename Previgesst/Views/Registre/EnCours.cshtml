@model Previgesst.ViewModels.EmployeRegistreViewModel
@using Previgesst.Ressources.Previcad
@using Previgesst.Ressources.Cadenassage
@using Previgesst.Ressources


<style>

    .k-grid-content {
        overflow-x: scroll !important;
    }
</style>

<style scoped>
    .armchair {
        overflow: auto;
        height: calc(100% - 70px);
        padding: 10px
    }

    .window-footer {
        position: absolute;
        bottom: 0;
        display: block;
        width: 95%;
        margin-top: 150px;
        padding: 10px;
        text-align: right;
        border-top: 1px solid #e5e5e5;
    }

    .armchair.fullheight {
        height: auto;
    }

        .armchair.fullheight .statusdropDownTemplate {
            pointer-events: none;
        }

</style>

<div class="panel panel-danger">

    <div class="panel-heading back-panel-light" style="font-size:larger;font-weight:500;color:white"></div>

    <div class="panel-body">


        <div id="Employes" class="tab-pane">

            @Html.AntiForgeryToken()

            @(Html.Kendo().Grid<LigneRegistreViewModel>()
                    .Name("listEnCours")
                    .Columns(columns =>
                    {

                        columns.Bound(e => e.NoFicheCadenassage)
                                .Title(PrevFicheRES.NoFiche)
                                .Filterable(f => f.Extra(false)
                                .Operators(operators => operators
                                        .ForString(str => str.Clear()
                                        .Contains(GridRES.Contains)
                                        .StartsWith(GridRES.StartsWith)
                                        .IsEqualTo(GridRES.Egale)
                                        .IsNotEqualTo(GridRES.NotEquals)
                        ))).Width(40);


                        columns.Bound(e => e.NomDepartement)
                                .Title(PrevFicheRES.Departement)
                                .Filterable(f => f.Extra(false)
                                .Operators(operators => operators
                                        .ForString(str => str.Clear()
                                        .Contains(GridRES.Contains)
                                        .StartsWith(GridRES.StartsWith)
                                        .IsEqualTo(GridRES.Egale)
                                        .IsNotEqualTo(GridRES.NotEquals)
                        ))).Width(100);


                        columns.Bound(e => e.NomEquipement)
                                .Title(PrevFicheRES.Equipement)
                                .Filterable(f => f.Extra(false)
                                .Operators(operators => operators
                                        .ForString(str => str.Clear()
                                        .Contains(GridRES.Contains)
                                        .StartsWith(GridRES.StartsWith)
                                        .IsEqualTo(GridRES.Egale)
                                        .IsNotEqualTo(GridRES.NotEquals)
                        ))).Width(100);


                        columns.Bound(e => e.EmployeRegistreId).Hidden(true);
                        columns.Bound(e => e.FicheCadenassageId).Hidden(true);
                        columns.Bound(e => e.DateDebut).Format("{0:yyyy-MM-dd HH:mm}").Filterable(f => f.Extra(false)).Title(PrevFicheRES.Debut).Width(70);

                        columns.Bound(e => e.DateFin).Format("{0:yyyy-MM-dd HH:mm}").Filterable(f => f.Extra(false)).Title(PrevFicheRES.Fin).Width(70);

                        columns.Bound(e => e.FinPrevue).Format("{0:yyyy-MM-dd HH:mm}").Filterable(f => f.Extra(false)).Title(PrevFicheRES.FinPrevueEmploye).Width(70);
                        columns.Bound(e => e.Note).Width(100);
                        columns.Bound(e => e.BonDeTravail).Title(PrevFicheRES.BonDeTravail).Width(50);



                        columns.Bound(e => e.LigneRegistreId).ClientTemplate("<a href='../../Registre/GetEtiquette/#= LigneRegistreId#' class='btn etiquetteButton' style='text-align:center' title="+ PrevFicheRES.Etiquette +"></a>").Title("").Filterable(false).Sortable(false).Width(55);

                        columns.Command(e => e.Custom("étapes").Click("showDetails").HtmlAttributes(new { @data_viewonly = "false" })).Width(100);

                        columns.Command(e => e.Edit().Text(PrevFicheRES.Modifier)).Width(20);
                    })
                    .DataSource(ds => ds
                    .Ajax()
                    .PageSize(10)

                    .Model(m =>
                    {
                        m.Id(e => e.LigneRegistreId);

                    }))

                    .Sortable(s => s.AllowUnsort(false))
                    .Scrollable(e => e.Enabled(true))
                    .ToolBar(tools => tools.Excel())
                    .Editable(e => e
                    .Mode(GridEditMode.PopUp)).Editable(editable => editable.Mode(GridEditMode.PopUp).TemplateName("LigneRegistre").Window(w => w.Title(PrevFicheRES.Cadenasser).Width(600))

                    .DisplayDeleteConfirmation(false)
                    )
                    .Pageable(s => s.PageSizes(true).PageSizes(new List<int> { 5, 10, 20, 50 }).Input(true).Info(false).Numeric(false))
                    .Filterable()
                    .DataSource(ds => ds
                        .Ajax().Events(e=>e.RequestEnd("doRefresh"))
                        .Filter(f =>
                        {
                            f.Add(b => b.Termine).IsEqualTo(false);
                        })
                        .Sort(x => x.Add(c => c.DateDebut).Descending())

                        .PageSize(20)


                        .Read(r => r.Action("ReadLignesRegistreCadenassageUnEmploye", "Registre", new { client = Model.ClientId }))
                        .Create(c => c.Action("SaveLigneRegistreUnEmploye", "Registre", new { client = Model.ClientId }))
                        .Update(u => u.Action("SaveLigneRegistreUnEmploye", "Registre", new { client = Model.ClientId }))
                        .Destroy(d => d.Action("DeleteLigneRegistreUnEmploye", "Registre", new { client = Model.ClientId }))
                    )
                    .Events(e => e.DataBound("dataBoundEnCours"))
                    .Events(e => e.Edit("onEditEnCours"))

        )


        </div>
    </div>
</div>


<div id="wnd">
    <div id="wrapped-grid" class="armchair"></div>
    <div class="window-footer">
        <input type="button" class="btn btn-info" id="btnSaveInstructionStatus" value="@CadEditRES.Enregistrer" />
    </div>
</div>


<script>
    function dataBoundEnCours(e) {
        var selecteurGrid = "#listEnCours";
        var grid = $(selecteurGrid).data("kendoGrid");


        $(selecteurGrid + " .k-grid-edit").find("span").remove();
        var classe = $(selecteurGrid + " .k-grid-edit").attr("class");
        classe = "btn btn-success " + classe;
        $(selecteurGrid + " .k-grid-edit").removeAttr("class").addClass(classe).removeClass("k-button").removeClass("k-button-icontext");
    }

    function onEditEnCours(e) {
        e.container.find(".k-grid-cancel").bind("click", function () {
            $("#listEnCours").data("kendoGrid").dataSource.read();
            $("#listTermines").data("kendoGrid").dataSource.read();
        })
    }

    function doRefresh(e) {
        if (e.type == "update") {
            $("#listEnCours").data("kendoGrid").dataSource.read();
            $("#listTermines").data("kendoGrid").dataSource.read();
        }
    }

    // Add img title
    setTimeout(function () {
        jQuery('.k-grid-edit').each(function () {
            jQuery(this).attr('title', 'Effectuez');
        });
    }, 3000);

    function showDetails(e) {
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var url = "@Url.Action("Instruction", "Registre")?ficheId=" + dataItem.FicheCadenassageId;

        var viewonly =  $(e.currentTarget).data("viewonly");

        $('.window-footer').show();
        $('.armchair').removeClass('fullheight');

        if (viewonly == "yes") {
            $('.window-footer').hide();
            $('.armchair').addClass('fullheight');
        }
        
        $("#wrapped-grid").empty();

        $("#wrapped-grid").kendoGrid({
            dataSource: {
                transport: {
                    read: {
                        url: url,
                        dataType: "json"
                    }
                }
            },

            /*height: "465px",*/
            scrollable: false,
            sortable: false,
            resizable: false,
            columns: [
                { field: "PKType", hidden: true },
                { field: "PKId", hidden: true },
                { field: "FicheCadenassageId", hidden: true },
                { field: "NoLigne", width: "60px", title: "#" },
                {
                    field: "TexteInstruction", title: "@CadLigneCadRES.Instruction",
                    template: "<b>#= TexteInstruction # </b><br> #= TexteSupplementaireInstruction == null ? '' : TexteSupplementaireInstruction #"
                },
                {
                    field: "TexteSupplementaireDispositif", title: "@CadLigneCadRES.Dispositif",
                    template: "<b>#= TexteDispositif # </b><br> #= TexteSupplementaireDispositif == null ? '' : TexteSupplementaireDispositif #"
                },
                { field: "TexteAccessoire", width: "100px", title: "@CadLigneCadRES.Accessoire" },

                {
                    field: "Thumbnail", title: "@CadLigneCadRES.Image",
                    template: "<img src='#=Thumbnail#'/>"
                },

                { field: "StepStatus", width: "80px", title: "@CadLigneCadRES.StepStatus", template: StatusTemplateFunction },
            ],

            dataBound: function (e) {
                var grid = e.sender;
                var items = e.sender.items();

                items.each(function (e) {
                    var dataItem = grid.dataItem(this);
                    var ddt = $(this).find('.statusdropDownTemplate');
                    //console.log('ddt dateItem', dataItem);

                    $(ddt).kendoDropDownList({
                        value: dataItem.StepStatus,
                        dataSource: ddlDataSource,
                        dataTextField: "displayValue",
                        dataValueField: "StepStatus",
                        change: onDDLStatusChange
                    });

                    if (viewonly == "yes") {
                        $(ddt).data("kendoDropDownList").enable(false);
                    }
                });
            }
        });


        var wnd = $("#wnd").kendoWindow({
            height: 500,
            width: 950,
            visible: false
        }).data("kendoWindow");

        wnd.title("@PrevFicheRES.OptionWindowTitle")
            .center()
            .open();
    }

    var ddlDataSource = [
        { StepStatus: 1, displayValue: "@PrevFicheRES.Option1" },
        { StepStatus: 2, displayValue: "@PrevFicheRES.Option2" },
        { StepStatus: 3, displayValue: "@PrevFicheRES.Option3" },
        { StepStatus: 4, displayValue: "@PrevFicheRES.Option4" }
    ];

    function onDDLStatusChange(e) {
        var element = e.sender.element;
        var row = element.closest("tr");
        var grid = $("#wrapped-grid").data("kendoGrid");
        var dataItem = grid.dataItem(row);

        /*dataItem.set("value", e.sender.value());*/
        dataItem.set("StepStatus", e.sender.value());
    };

    function StatusTemplateFunction(dataItem) {
        var input = '<input class="statusdropDownTemplate"/>'

        return input
    };

    $(document).on('click', '#btnSaveInstructionStatus', function () {

        var entityGrid = $("#wrapped-grid").data("kendoGrid");
        var data = entityGrid.dataSource.data();
        var totalNumber = data.length;
        var allData = [];

        for (var i = 0; i < totalNumber; i++) {
            var currentDataItem = data[i];

            //console.log('StepStatus ddl', entityGrid.dataSource._data[i]);

            allData.push({
                PKId: 0,
                InstructionId: currentDataItem.PKId,
                InstructionType: currentDataItem.PKType,
                StepStatus: currentDataItem.StepStatus,
                FicheCadenassageId: currentDataItem.FicheCadenassageId
            });
        }

        console.log(allData);


        $.ajax({
            url: "@Url.Action("SaveInstructions", "Registre")",
            type: 'POST',
            data: { model: allData },
            dataType: 'json',
            cache: false,
            success: function (result) {
                if (result.isSuccess == true) {
                    $('#wrapped-grid').data('kendoGrid').dataSource.read();
                }
            },
            error: function (req, status, errorObj) {
            }
        });
    });


</script>


